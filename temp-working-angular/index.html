<!DOCTYPE html>
<html>
<head>
  <title></title>

<!-- STYLES -->
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">


<!-- SCRIPTS -->
  <script src="https://static.opentok.com/v2/js/opentok.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.5/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.5/angular-route.min.js"></script>
  <script src="node_modules/opentok-layout-js/opentok-layout.js" type="text/javascript" charset="utf-8"></script>
  <script src="node_modules/opentok-angular/opentok-angular.js" type="text/javascript" charset="utf-8"></script>
</head>

<body ng-app="myApp">

</body>


<body ng-app="myApp">
  <div ng-controller="VideoController">
      <ot-layout props="{animate:true}">
          <ot-subscriber ng-repeat="stream in streams"
              stream="stream"
              props="{style: {nameDisplayMode: 'off'}}">
          </ot-subscriber>
          <ot-publisher id="publisher"
              props="{style: {nameDisplayMode: 'off'}, resolution: '1280x720', frameRate: 30}">
          </ot-publisher>
      </ot-layout>
  </div>

  <script type="text/ng-template" id="home.html">
    <div class="container">
      <div class="col-md-3 col-sm-3"></div>
      <div class="col-md-6 col-sm-6">
        <div class="videoContainer">
          <p><a href="#" class="btn btn-success" id="start-call" ng-click="createVideo()">Start call</a></p>
          <div id="otEmbedContainer" ></div>
          <p><a href="#" class="btn btn-danger" id="end-call" ng-click="endSession()">End call</a></p>
        </div>

        <div id="publisher"></div>
        <div id="publisher1"></div>

        <div id="subscribers"></div>
        <div id="subscribers2"></div>
      </div>
      </div>
      <div class="col-md-3 col-sm-3"></div>
    </div>

  </script>
  <script type="text/ng-template" id="oneMore.html">
    other view
  </script>

<script type="text/javascript">

angular.module('demo', ['opentok'])
  .controller('MyCtrl', ['$scope', 'OTSession', 'apiKey', 'sessionId', 'token', function($scope, OTSession, apiKey, sessionId, token) {
      console.log(OTSession)
      OTSession.init(apiKey, sessionId, token);
      $scope.streams = OTSession.streams;
  }]).value({
      apiKey: 'YOUR_API_KEY',
      sessionId: 'YOUR_SESSION_ID',
      token: 'YOUR_TOKEN'
  });

var app = angular.module( "myApp", ['opentok'] );

app.factory('sessionFactory', ['$http', function($http) {
  var service = {
    createSession: function(sessionData) {
      return $http.post('/videos/' + sessionData.caller_id + '/users/' + sessionData.callee_id, sessionData)
        .then(function(response) {
          return alert("success");
        })
        .catch(function(error) {
          console.error('Failed post. Error: ' + error.data);
        })
    },
    getNewToken: function(session_name) {
      return $http.get('/videos/' + session_name)
        .then(function (response) {
          return response.data
        })
        .catch(function(error) {
          console.error('Failed to get token. Error: ' + error.data);
        })
    },
    deleteSession: function(session_name) {
      return $http.delete('/videos/' + session_name)
        .then( function (response){
          return response.data
        })
        .catch(function(error) {
          console.error('Failed to delete session. Error: ' + error.data);
        })
    }
  };
  return service;
}])

app.controller('VideoController', ['$scope', '$http', '$window', '$log', 'OTSession', function($scope, $http, $window, $log, OTSession, sessionFactory) {

  //OTSession.init("45786882" ,"aafd067184ed09d50dd472d8808afb733568599b",0);

  console.log(OTSession)
  $scope.streams = OTSession.streams;
  $scope.connections = OTSession.connections;
  $scope.publishing = false;
  $scope.archiveId = null;
  $scope.archiving = false;
  $scope.connected = false;
  $scope.reconnecting = false;
  $scope.leaving = false;

  $scope.getVideo = function() {
    if ($scope.session) {
      $scope.session.disconnect();
    }

    OTSession.init(45786882, '1_MX40NTc2MjMwMn5-MTQ4ODY1NjQ3NTI2NH5mRVFwa1hYNzUzOS9mRmdYc2h4WGljdDJ-UH4', 'T1==cGFydG5lcl9pZD00NTc2MjMwMiZzaWc9NGJlODVmNWQzNjkzYTFjNDkxNmIxZjYzMmJkNmY1NDUzMDVlYzRmNDpzZXNzaW9uX2lkPTFfTVg0ME5UYzJNak13TW41LU1UUTRPRFkxTmpRM05USTJOSDVtUlZGd2ExaFlOelV6T1M5bVJtZFljMmg0V0dsamRESi1VSDQmY3JlYXRlX3RpbWU9MTQ4ODY1NjQ3NSZub25jZT0wLjk5Nzg3OTMyNDY3Mzc5MTQmcm9sZT1wdWJsaXNoZXImZXhwaXJlX3RpbWU9MTQ4ODc0Mjg3NQ==', function(err, session) {
      if (err) {
        $scope.$broadcast('otError', {message: 'initialize session error'});
        return;
      }
      $scope.session = session;
    
      var connectDisconnect = function(connected) {
            $scope.$apply(function() {
              $scope.connected = connected;
              $scope.reconnecting = false;
              if (!connected) {
                $scope.publishing = false;
              }
            });
      }

      var reconnecting = function(isReconnecting) {
        $scope.$apply(function() {
          $scope.reconnecting = isReconnecting;
        });
      };
      if ((session.is && session.is('connected')) || session.connected) {
        connectDisconnect(true);
      }
      $scope.session.on('sessionConnected', connectDisconnect.bind($scope.session, true));
      $scope.session.on('sessionDisconnected', connectDisconnect.bind($scope.session, false));
      $scope.session.on('archiveStarted archiveStopped', function(event) {
        // event.id is the archiveId
        $scope.$apply(function() {
          $scope.archiveId = event.id;
          $scope.archiving = (event.type === 'archiveStarted');
        });
      });
      $scope.session.on('sessionReconnecting', reconnecting.bind($scope.session, true));
      $scope.session.on('sessionReconnected', reconnecting.bind($scope.session, false));
    });    
    $scope.publishing = true;
  }

  $scope.$on('$destroy', function() {
    if ($scope.session && $scope.connected) {
      $scope.session.disconnect();
      $scope.connected = false;
    }
    $scope.session = null;
  });

  $scope.changeRoom = function() {
    if (!$scope.leaving) {
      $scope.leaving = true;
      $scope.session.disconnect();
      
      $scope.session.on('sessionDisconnected', function() {
        console.log('Session disconnected.')
      });
    }
  };

}])

</script>
</body>
</html>
